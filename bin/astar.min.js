window.ai={},window.__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),function(t){var e=function(){return function(){this.priority=0,this.insertionIndex=0,this.queueIndex=0}}();t.PriorityQueueNode=e}(ai||(ai={})),function(t){var e=function(){function e(){}return e.search=function(e,o,i,r){void 0===r&&(r=new Map);var s=!1,a=o.x+"_"+o.y;r.set(a,o);var u=new Map,h=new t.PriorityQueue(1e3);h.enqueue(new n(o),0),u.set(a,0);for(var d=function(){var t=h.dequeue();if(t.data.equals(i))return s=!0,"break";e.getNeighbors(t.data).forEach(function(o){var s=u.get(t.data.x+"_"+t.data.y)+e.cost(t.data,o),a=o.x+"_"+o.y;if(!u.has(a)||s<u.get(a)){u.set(a,s);var d=s+e.heuristic(o,i);h.enqueue(new n(o),d),r.set(o.x+"_"+o.y,t.data)}})};h.count>0;){if("break"===d())break}return s},e.searchR=function(t,e,n){var o=new Map;return this.search(t,e,n,o)?this.recontructPath(o,e,n):null},e.recontructPath=function(t,e,n){var o=[],i=n.clone();for(o.push(n);i&&!i.equals(e);)i=t.get(i.x+"_"+i.y),o.push(i);return o.reverse(),o},e}();t.AStarPathfinder=e;var n=function(t){function e(e){var n=t.call(this)||this;return n.data=e,n}return __extends(e,t),e}(t.PriorityQueueNode)}(ai||(ai={})),function(t){var e=function(){function e(t,e){this.dirs=[new es.Vector2(1,0),new es.Vector2(0,-1),new es.Vector2(-1,0),new es.Vector2(0,1)],this.walls=[],this.weightedNodes=[],this.defaultWeight=1,this.weightedNodeWeight=5,this._neighbors=new Array(4),this._width=t,this._height=e}return e.prototype.isNodeInBounds=function(t){return 0<=t.x&&t.x<this._width&&0<=t.y&&t.y<this._height},e.prototype.isNodePassable=function(t){return!new es.List(this.walls).firstOrDefault(function(e){return e.equals(t)})},e.prototype.search=function(e,n){return t.AStarPathfinder.search(this,e,n)},e.prototype.getNeighbors=function(t){var e=this;return this._neighbors.length=0,this.dirs.forEach(function(n){var o=new es.Vector2(t.x+n.x,t.y+n.y);e.isNodeInBounds(o)&&e.isNodePassable(o)&&e._neighbors.push(o)}),this._neighbors},e.prototype.cost=function(t,e){return this.weightedNodes.find(function(t){return t.equals(e)})?this.weightedNodeWeight:this.defaultWeight},e.prototype.heuristic=function(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)},e}();t.AstarGridGraph=e}(ai||(ai={})),function(t){var e=function(){function t(t){this._numNodes=0,this._nodes=new Array(t+1),this._numNodesEverEnqueued=0}return Object.defineProperty(t.prototype,"count",{get:function(){return this._numNodes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxSize",{get:function(){return this._nodes.length-1},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this._nodes.splice(1,this._numNodes),this._numNodes=0},t.prototype.contains=function(t){return t?t.queueIndex<0||t.queueIndex>=this._nodes.length?(console.error("node.QueueIndex has been corrupted. Did you change it manually? Or add this node to another queue?"),!1):this._nodes[t.queueIndex]==t:(console.error("node cannot be null"),!1)},t.prototype.enqueue=function(t,e){t.priority=e,this._numNodes++,this._nodes[this._numNodes]=t,t.queueIndex=this._numNodes,t.insertionIndex=this._numNodesEverEnqueued++,this.cascadeUp(this._nodes[this._numNodes])},t.prototype.dequeue=function(){var t=this._nodes[1];return this.remove(t),t},t.prototype.remove=function(t){if(t.queueIndex==this._numNodes)return this._nodes[this._numNodes]=null,void this._numNodes--;var e=this._nodes[this._numNodes];this.swap(t,e),delete this._nodes[this._numNodes],this._numNodes--,this.onNodeUpdated(e)},t.prototype.isValidQueue=function(){for(var t=1;t<this._nodes.length;t++)if(this._nodes[t]){var e=2*t;if(e<this._nodes.length&&this._nodes[e]&&this.hasHigherPriority(this._nodes[e],this._nodes[t]))return!1;var n=e+1;if(n<this._nodes.length&&this._nodes[n]&&this.hasHigherPriority(this._nodes[n],this._nodes[t]))return!1}return!0},t.prototype.onNodeUpdated=function(t){var e=Math.floor(t.queueIndex/2),n=this._nodes[e];e>0&&this.hasHigherPriority(t,n)?this.cascadeUp(t):this.cascadeDown(t)},t.prototype.cascadeDown=function(t){for(var e,n=t.queueIndex;;){e=t;var o=2*n;if(o>this._numNodes){t.queueIndex=n,this._nodes[n]=t;break}var i=this._nodes[o];this.hasHigherPriority(i,e)&&(e=i);var r=o+1;if(r<=this._numNodes){var s=this._nodes[r];this.hasHigherPriority(s,e)&&(e=s)}if(e==t){t.queueIndex=n,this._nodes[n]=t;break}this._nodes[n]=e;var a=e.queueIndex;e.queueIndex=n,n=a}},t.prototype.cascadeUp=function(t){for(var e=Math.floor(t.queueIndex/2);e>=1;){var n=this._nodes[e];if(this.hasHigherPriority(n,t))break;this.swap(t,n),e=Math.floor(t.queueIndex/2)}},t.prototype.swap=function(t,e){this._nodes[t.queueIndex]=e,this._nodes[e.queueIndex]=t;var n=t.queueIndex;t.queueIndex=e.queueIndex,e.queueIndex=n},t.prototype.hasHigherPriority=function(t,e){return t.priority<e.priority||t.priority==e.priority&&t.insertionIndex<e.insertionIndex},t}();t.PriorityQueue=e}(ai||(ai={})),function(t){var e=function(){function e(){}return e.search=function(t,e,n,o){void 0===o&&(o=new Map);var i=!1,r=[];r.unshift(e),o.set(e.x+"_"+e.y,e);for(var s=function(){var s=r.shift();if(s.equals(n))return i=!0,"break";t.getNeighbors(s).forEach(function(t){o.has(e.x+"_"+e.y)||(r.unshift(t),o.set(e.x+"_"+e.y,s))})};r.length>0;){if("break"===s())break}return i},e.searchR=function(e,n,o){var i=new Map;return this.search(e,n,o,i)?t.AStarPathfinder.recontructPath(i,n,o):null},e}();t.BreadthFirstPathfinder=e}(ai||(ai={})),function(t){var e=function(){function t(){this.edges=new Map}return t.prototype.addEdgesForNode=function(t,e){return this.edges.set(t,e),this},t.prototype.getNeighbors=function(t){return this.edges.get(t)},t}();t.UnweightedGraph=e}(ai||(ai={})),function(t){var e=function(){function e(t,n,o){void 0===o&&(o=!1),this.walls=[],this._neighbors=new Array(4),this._width=t,this._hegiht=n,this._dirs=o?e.COMPASS_DIRS:e.CARDINAL_DIRS}return e.prototype.isNodeInBounds=function(t){return 0<=t.x&&t.x<this._width&&0<=t.y&&t.y<this._hegiht},e.prototype.isNodePassable=function(t){return!new es.List(this.walls).firstOrDefault(function(e){return JSON.stringify(e)==JSON.stringify(t)})},e.prototype.getNeighbors=function(t){var e=this;return this._neighbors.length=0,this._dirs.forEach(function(n){var o=new es.Vector2(t.x+n.x,t.y+n.y);e.isNodeInBounds(o)&&e.isNodePassable(o)&&e._neighbors.push(o)}),this._neighbors},e.prototype.search=function(e,n){return t.BreadthFirstPathfinder.searchR(this,e,n)},e.CARDINAL_DIRS=[new es.Vector2(1,0),new es.Vector2(0,-1),new es.Vector2(-1,0),new es.Vector2(0,-1)],e.COMPASS_DIRS=[new es.Vector2(1,0),new es.Vector2(1,-1),new es.Vector2(0,-1),new es.Vector2(-1,-1),new es.Vector2(-1,0),new es.Vector2(-1,1),new es.Vector2(0,1),new es.Vector2(1,1)],e}();t.UnweightedGridGraph=e}(ai||(ai={})),function(t){var e=function(){function e(t,n,o){void 0===o&&(o=!1),this.walls=[],this.weightedNodes=[],this.defaultWeight=1,this.weightedNodeWeight=5,this._neighbors=new Array(4),this._width=t,this._height=n,this._dirs=o?e.COMPASS_DIRS:e.CARDINAL_DIRS}return e.prototype.isNodeInBounds=function(t){return 0<=t.x&&t.x<this._width&&0<=t.y&&t.y<this._height},e.prototype.isNodePassable=function(t){return!new es.List(this.walls).firstOrDefault(function(e){return JSON.stringify(e)==JSON.stringify(t)})},e.prototype.search=function(e,n){return t.WeightedPathfinder.search(this,e,n)},e.prototype.getNeighbors=function(t){var e=this;return this._neighbors.length=0,this._dirs.forEach(function(n){var o=new es.Vector2(t.x+n.x,t.y+n.y);e.isNodeInBounds(o)&&e.isNodePassable(o)&&e._neighbors.push(o)}),this._neighbors},e.prototype.cost=function(t,e){return this.weightedNodes.find(function(t){return JSON.stringify(t)==JSON.stringify(e)})?this.weightedNodeWeight:this.defaultWeight},e.CARDINAL_DIRS=[new es.Vector2(1,0),new es.Vector2(0,-1),new es.Vector2(-1,0),new es.Vector2(0,1)],e.COMPASS_DIRS=[new es.Vector2(1,0),new es.Vector2(1,-1),new es.Vector2(0,-1),new es.Vector2(-1,-1),new es.Vector2(-1,0),new es.Vector2(-1,1),new es.Vector2(0,1),new es.Vector2(1,1)],e}();t.WeightedGridGraph=e}(ai||(ai={})),function(t){var e=function(t){function e(e){var n=t.call(this)||this;return n.data=e,n}return __extends(e,t),e}(t.PriorityQueueNode);t.WeightedNode=e;var n=function(){function n(){}return n.search=function(n,o,i,r){void 0===r&&(r=new Map);var s=!1,a=o.x+"_"+o.y;r.set(a,o);var u=new Map,h=new t.PriorityQueue(1e3);h.enqueue(new e(o),0),u.set(a,0);for(var d=function(){var t=h.dequeue();if(t.data.equals(i))return s=!0,"break";n.getNeighbors(t.data).forEach(function(o){var i=u.get(t.data.x+"_"+t.data.y)+n.cost(t.data,o),s=o.x+"_"+o.y;if(!u.has(s)||i<u.get(s)){u.set(s,i);var a=i;h.enqueue(new e(o),a),r.set(o.x+"_"+o.y,t.data)}})};h.count>0;){if("break"===d())break}return s},n.searchR=function(t,e,n){var o=new Map;return this.search(t,e,n,o)?this.recontructPath(o,e,n):null},n.recontructPath=function(t,e,n){var o=[],i=n;for(o.push(n);i&&!i.equals(e);)i=t.get(i.x+"_"+i.y),o.push(i);return o.reverse(),o},n}();t.WeightedPathfinder=n}(ai||(ai={})),function(t){var e=function(){function e(){this._opened=new Array(e.MAX_NODES),this._closed=new Array(e.MAX_NODES)}return e.prototype.clear=function(){for(var e=0;e<this._numOpened;e++)es.Pool.free(t.AStarNode,this._opened[e]),this._opened[e]=null;for(e=0;e<this._numClosed;e++)es.Pool.free(t.AStarNode,this._closed[e]),this._closed[e]=null;this._numOpened=this._numClosed=0,this._lastFoundClosed=this._lastFoundOpened=0},e.prototype.findOpened=function(t){for(var e=0;e<this._numOpened;e++){var n=-1^t.worldState.dontCare;if((t.worldState.values&n)==(this._opened[e].worldState.values&n))return this._lastFoundClosed=e,this._closed[e]}return null},e.prototype.findClosed=function(t){for(var e=0;e<this._numClosed;e++){var n=-1^t.worldState.dontCare;if((t.worldState.values&n)==(this._closed[e].worldState.values&n))return this._lastFoundClosed=e,this._closed[e]}return null},e.prototype.hasOpened=function(){return this._numOpened>0},e.prototype.removeOpened=function(t){this._numOpened>0&&(this._opened[this._lastFoundOpened]=this._opened[this._numOpened-1]),this._numOpened--},e.prototype.removeClosed=function(t){this._numClosed>0&&(this._closed[this._lastFoundClosed]=this._closed[this._numClosed-1]),this._numClosed--},e.prototype.isOpen=function(t){return this._opened.indexOf(t)>-1},e.prototype.isClosed=function(t){return this._closed.indexOf(t)>-1},e.prototype.addToOpenList=function(t){this._opened[this._numOpened++]=t},e.prototype.addToClosedList=function(t){this._closed[this._numClosed++]=t},e.prototype.removeCheapestOpenNode=function(){var t=Number.MAX_VALUE;this._lastFoundOpened=-1;for(var e=0;e<this._numOpened;e++)this._opened[e].costSoFarAndHeuristicCost<t&&(t=this._opened[e].costSoFarAndHeuristicCost,this._lastFoundOpened=e);var n=this._opened[this._lastFoundOpened];return this.removeOpened(n),n},e.MAX_NODES=128,e}();t.AStarStorage=e}(ai||(ai={})),function(t){var e=function(){function t(){}return t.prototype.equals=function(t){var e=-1^this.worldState.dontCare;return(this.worldState.values&e)==(t.worldState.values&e)},t.prototype.compareTo=function(t){return this.costSoFarAndHeuristicCost-t.costSoFarAndHeuristicCost},t.prototype.reset=function(){this.action=null,this.parent=null},t.prototype.clone=function(){var e=new t;return e.action=this.action,e.costSoFar=this.costSoFar,e.depth=this.depth,e.parent=this.parent,e.parentWorldState=this.parentWorldState,e.heuristicCost=this.heuristicCost,e.worldState=this.worldState,e},t.prototype.toString=function(){return"[cost: "+this.costSoFar+" | heuristic: "+this.heuristicCost+"]: "+this.action},t}();t.AStarNode=e;var n=function(){function n(){}return n.plan=function(t,n,o,i){void 0===i&&(i=null),this.storage.clear();var r=es.Pool.obtain(e);for(r.worldState=n,r.parentWorldState=n,r.costSoFar=0,r.heuristicCost=this.calculateHeuristic(n,o),r.costSoFarAndHeuristicCost=r.costSoFar+r.heuristicCost,r.depth=1,this.storage.addToOpenList(r);;){if(!this.storage.hasOpened())return this.storage.clear(),null;if(r=this.storage.removeCheapestOpenNode(),this.storage.addToClosedList(r),o.equals(r.worldState)){var s=this.reconstructPlan(r,i);return this.storage.clear(),s}for(var a=t.getPossibleTransitions(r.worldState),u=0;u<a.length;u++){var h=a[u],d=this.storage.findOpened(h),c=this.storage.findClosed(h),l=r.costSoFar+h.costSoFar;if(null!=d&&l<d.costSoFar&&(this.storage.removeOpened(d),d=null),null!=c&&l<c.costSoFar&&this.storage.removeClosed(c),null==d&&null==c){var p=es.Pool.obtain(e);p.worldState=h.worldState,p.costSoFar=l,p.heuristicCost=this.calculateHeuristic(h.worldState,o),p.costSoFarAndHeuristicCost=p.costSoFar+p.heuristicCost,p.action=h.action,p.parentWorldState=r.worldState,p.parent=r,p.depth=r.depth+1,this.storage.addToOpenList(p)}}es.ListPool.free(e,a)}},n.reconstructPlan=function(t,e){for(var n=t.depth-1,o=new Array(n),i=t,r=0;r<=n-1;r++)null!=e&&e.push(i.clone()),o.push(i.action),i=i.parent;return null!=e&&e.reverse(),o},n.calculateHeuristic=function(e,n){for(var o=-1^n.dontCare,i=e.values&o^n.values&o,r=0,s=0;s<t.ActionPlanner.MAX_CONDITIONS;++s)0!=(i&1<<s)&&r++;return r},n.storage=new t.AStarStorage,n}();t.AStar=n}(ai||(ai={})),function(t){var e=function(){function t(t,e){void 0===e&&(e=1),this.cost=1,this._preConditions=new Set,this._postConditions=new Set,this.name=t,this.cost=e}return t.prototype.setPrecondition=function(t,e){this._preConditions.add([t,e])},t.prototype.setPostcondition=function(t,e){this._preConditions.add([t,e])},t.prototype.validate=function(){return!0},t.prototype.toString=function(){return"[Action] "+this.name+" - cost: "+this.cost},t}();t.Action=e}(ai||(ai={})),function(t){var e=function(){function e(){this.conditionNames=new Array(e.MAX_CONDITIONS),this._actions=[],this._viableActions=[],this._preConditions=new Array(e.MAX_CONDITIONS),this._postConditions=new Array(e.MAX_CONDITIONS),this._numConditionNames=0;for(var n=0;n<e.MAX_CONDITIONS;++n)this.conditionNames[n]=null,this._preConditions[n]=t.WorldState.create(this),this._postConditions[n]=t.WorldState.create(this)}return e.prototype.createWorldState=function(){return t.WorldState.create(this)},e.prototype.addAction=function(t){var e=this,n=this.findActionIndex(t);if(-1==n)throw new Error("无法找到或创建行动");t._preConditions.forEach(function(t){var o=e.findConditionNameIndex(t[0]);if(-1==o)throw new Error("无法找到或创建条件名称");e._preConditions[n].set(o,t[1])}),t._postConditions.forEach(function(t){var o=e.findConditionNameIndex(t[0]);if(-1==o)throw new Error("找不到条件名称");e._postConditions[n].set(o,t[1])})},e.prototype.plan=function(e,n,o){void 0===o&&(o=null),this._viableActions.length=0;for(var i=0;i<this._actions.length;i++)this._actions[i].validate()&&this._viableActions.push(this._actions[i]);return t.AStar.plan(this,e,n,o)},e.prototype.getPossibleTransitions=function(e){for(var n=es.ListPool.obtain(t.AStarNode),o=0;o<this._viableActions.length;++o){var i=this._preConditions[o],r=-1^i.dontCare;if((i.values&r)==(e.values&r)){var s=es.Pool.obtain(t.AStarNode);s.action=this._viableActions[o],s.costSoFar=this._viableActions[o].cost,s.worldState=this.applyPostConditions(this,o,e),n.push(s)}}return n},e.prototype.applyPostConditions=function(t,e,n){var o=t._postConditions[e],i=o.dontCare,r=-1^i;return n.values=n.values&i|o.values&r,n.dontCare&=o.dontCare,n},e.prototype.findConditionNameIndex=function(t){var n;for(n=0;n<this._numConditionNames;++n)if(this.conditionNames[n]==t)return n;return n<e.MAX_CONDITIONS-1?(this.conditionNames[n]=t,this._numConditionNames++,n):-1},e.prototype.findActionIndex=function(t){var e=this._actions.indexOf(t);return e>-1?e:(this._actions.push(t),this._actions.length-1)},e.MAX_CONDITIONS=64,e}();t.ActionPlanner=e}(ai||(ai={})),function(t){var e=function(){function e(){this._planner=new t.ActionPlanner}return e.prototype.plan=function(e){void 0===e&&(e=!1);var n=null;if(e&&(n=[]),this.actions=this._planner.plan(this.getWorldState(),this.getGoalState(),n),null!=n&&n.length>0){console.log("---- ActionPlanner plan ----"),console.log("plan cost = "+n[n.length-1].costSoFar),console.log("               start\t"+this.getWorldState().describe(this._planner));for(var o=0;o<n.length;o++)console.log(o+": "+n[o].action.name+"\t"+n[o].worldState.describe(this._planner)),es.Pool.free(t.AStarNode,n[o])}return this.hasActionPlan()},e.prototype.hasActionPlan=function(){return null!=this.actions&&this.actions.length>0},e}();t.Agent=e}(ai||(ai={})),function(t){var e=function(){function e(t,e,n){this.planner=t,this.values=e,this.dontCare=n}return e.create=function(t){return new e(t,0,-1)},e.prototype.set=function(t,e){return"string"==typeof t?this.set(this.planner.findConditionNameIndex(t),e):(this.values=e?this.values|1<<t:this.values&~(1<<t),this.dontCare^=1<<t,!0)},e.prototype.equals=function(t){var e=-1^this.dontCare;return(this.values&e)==(t.values&e)},e.prototype.describe=function(e){for(var n="",o=0;o<t.ActionPlanner.MAX_CONDITIONS;o++)if(0==(this.dontCare&1<<o)){var i=e.conditionNames[o];if(null==i)continue;var r=0!=(this.values&1<<o);n.length>0&&(n+=", "),n+=r?i.toUpperCase():i}return n},e}();t.WorldState=e}(ai||(ai={}));